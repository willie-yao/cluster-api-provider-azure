- op: add
  path: /spec/kubeadmConfigSpec/files/-
  value:
    content: |
      #!/bin/bash

      set -o nounset
      set -o pipefail
      set -o errexit
      [[ $(id -u) != 0 ]] && SUDO="sudo" || SUDO=""

      LINE_SEPARATOR="*************************************************"
      echo "$$LINE_SEPARATOR"

      # Custom image handling
      if [[ -n "${KUBE_APISERVER_IMAGE:-}" ]]; then
        echo "* Using custom kube-apiserver image: ${KUBE_APISERVER_IMAGE}"
        echo "* Pulling kube-apiserver: ${KUBE_APISERVER_IMAGE}"
        $${SUDO} ctr -n k8s.io images pull "${KUBE_APISERVER_IMAGE}"
      else
        echo "* Custom kube-apiserver image environment variable not set, using default"
      fi

      if [[ -n "${KUBE_CONTROLLER_MANAGER_IMAGE:-}" ]]; then
        echo "* Using custom kube-controller-manager image: ${KUBE_CONTROLLER_MANAGER_IMAGE}"
        echo "* Pulling kube-controller-manager: ${KUBE_CONTROLLER_MANAGER_IMAGE}"
        $${SUDO} ctr -n k8s.io images pull "${KUBE_CONTROLLER_MANAGER_IMAGE}"
      else
        echo "* Custom kube-controller-manager image environment variable not set, using default"
      fi

      if [[ -n "${KUBE_SCHEDULER_IMAGE:-}" ]]; then
        echo "* Using custom kube-scheduler image: ${KUBE_SCHEDULER_IMAGE}"
        echo "* Pulling kube-scheduler: ${KUBE_SCHEDULER_IMAGE}"
        $${SUDO} ctr -n k8s.io images pull "${KUBE_SCHEDULER_IMAGE}"
      else
        echo "* Custom kube-scheduler image environment variable not set, using default"
      fi

      if [[ -n "${KUBE_PROXY_IMAGE:-}" ]]; then
        echo "* Using custom kube-proxy image: ${KUBE_PROXY_IMAGE}"
        echo "* Pulling kube-proxy: ${KUBE_PROXY_IMAGE}"
        $${SUDO} ctr -n k8s.io images pull "${KUBE_PROXY_IMAGE}"
      else
        echo "* Custom kube-proxy image environment variable not set, using default"
      fi

      echo "* checking binary versions"
      echo "ctr version: " $(ctr version)
      echo "kubeadm version: " $(kubeadm version -o=short)
      echo "kubectl version: " $(kubectl version --client=true)
      echo "kubelet version: " $(kubelet --version)
      echo "$$LINE_SEPARATOR"
    path: /tmp/kubeadm-bootstrap.sh
    owner: "root:root"
    permissions: "0744"
- op: add
  path: /spec/kubeadmConfigSpec/preKubeadmCommands/-
  value:
    bash -c /tmp/kubeadm-bootstrap.sh
- op: add
  path: /spec/kubeadmConfigSpec/clusterConfiguration/imageRepository
  value: upstream.azurecr.io/oss/v2/kubernetes
- op: add
  path: /spec/kubeadmConfigSpec/verbosity
  value: 5
