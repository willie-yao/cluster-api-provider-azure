- op: add
  path: /spec/template/spec/files/-
  value:
    content: |
      #!/bin/bash

      set -o nounset
      set -o pipefail
      set -o errexit

      systemctl stop kubelet

      declare -a BINARIES=("kubectl" "kubelet" "kubeadm")

      # Define the base URL and version
      BASE_URL="https://kubernetesreleases.blob.core.windows.net/dalec-packages"
      VERSION="${KUBERNETES_VERSION}"
      VERSION=$${VERSION#v}
      OS_VERSION="ubuntu24.04"
      ARCH="amd64"

      for BINARY in "$${BINARIES[@]}"; do
        if [[ "$${BINARY}" == "kubelet" ]]; then
          DEB_VERSION="ubuntu24.04u1"
        else
          DEB_VERSION="ubuntu24.04u2"
        fi
        echo "* downloading and installing package: $${BINARY} $${VERSION} with deb version $${DEB_VERSION}"
        DEB_FILE="/tmp/$${BINARY}_$${VERSION}-$${DEB_VERSION}_$${ARCH}.deb"
        DEB_URL="$${BASE_URL}/$${BINARY}/$${VERSION}/$${OS_VERSION}/$${ARCH}/$${BINARY}_$${VERSION}-$${DEB_VERSION}_$${ARCH}.deb"

        echo "Downloading from: $${DEB_URL}"
        curl -L --retry 10 --retry-delay 5 "$${DEB_URL}" --output "$${DEB_FILE}"
        chmod 644 "$${DEB_FILE}"

        echo "Installing $${DEB_FILE}"
        dpkg -i "$${DEB_FILE}"

        # Clean up the downloaded deb file
        rm -f "$${DEB_FILE}"
      done

      systemctl restart kubelet
      
      # Print kubelet logs to verify it's working
      echo "Kubelet logs after restart:"
      journalctl -u kubelet --no-pager -l --since "1 minute ago" || echo "Failed to get kubelet logs"
    path: /tmp/replace-k8s-binaries.sh
    owner: "root:root"
    permissions: "0744"
- op: add
  path: /spec/template/spec/preKubeadmCommands/-
  value:
    bash -c /tmp/replace-k8s-binaries.sh
