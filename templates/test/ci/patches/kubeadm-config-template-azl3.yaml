apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: ${CLUSTER_NAME}-md-0
spec:
  template:
    spec:
      preKubeadmCommands:
      - |
        # Install ca-certificates packages for Azure Linux
        tdnf install -y ca-certificates ca-certificates-legacy
        update-ca-trust
        
        # Change default policy to ACCEPT
        iptables -P INPUT ACCEPT
        iptables -P FORWARD ACCEPT
        iptables -P OUTPUT ACCEPT

        ip6tables -P INPUT ACCEPT
        ip6tables -P FORWARD ACCEPT
        ip6tables -P OUTPUT ACCEPT

        iptables-save > /etc/systemd/scripts/ip4save
        ip6tables-save > /etc/systemd/scripts/ip6save
