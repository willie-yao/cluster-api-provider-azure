- op: add
  path: /spec/kubeadmConfigSpec/files/-
  value:
    content: |
      #!/bin/bash

      set -o nounset
      set -o pipefail
      set -o errexit
      [[ $(id -u) != 0 ]] && SUDO="sudo" || SUDO=""

      # This test installs release packages or binaries that are a result of the CI and release builds.
      # It runs '... --version' commands to verify that the binaries are correctly installed
      # and finally uninstalls the packages.
      # For the release packages it tests all versions in the support skew.
      LINE_SEPARATOR="*************************************************"
      echo "$$LINE_SEPARATOR"
      
      # Custom image handling
      if [[ -n "${KUBE_APISERVER_IMAGE:-}" ]] && [[ -n "${KUBE_CONTROLLER_MANAGER_IMAGE:-}" ]] && [[ -n "${KUBE_SCHEDULER_IMAGE:-}" ]] && [[ -n "${KUBE_PROXY_IMAGE:-}" ]]; then
        echo "* Using custom Kubernetes images"
        
        # Pull and tag custom images
        echo "* Pulling kube-apiserver: ${KUBE_APISERVER_IMAGE}"
        $${SUDO} ctr -n k8s.io images pull "${KUBE_APISERVER_IMAGE}"
        $${SUDO} ctr -n k8s.io images tag "${KUBE_APISERVER_IMAGE}" "registry.k8s.io/kube-apiserver:latest"
        
        echo "* Pulling kube-controller-manager: ${KUBE_CONTROLLER_MANAGER_IMAGE}"
        $${SUDO} ctr -n k8s.io images pull "${KUBE_CONTROLLER_MANAGER_IMAGE}"
        $${SUDO} ctr -n k8s.io images tag "${KUBE_CONTROLLER_MANAGER_IMAGE}" "registry.k8s.io/kube-controller-manager:latest"
        
        echo "* Pulling kube-scheduler: ${KUBE_SCHEDULER_IMAGE}"
        $${SUDO} ctr -n k8s.io images pull "${KUBE_SCHEDULER_IMAGE}"
        $${SUDO} ctr -n k8s.io images tag "${KUBE_SCHEDULER_IMAGE}" "registry.k8s.io/kube-scheduler:latest"
        
        echo "* Pulling kube-proxy: ${KUBE_PROXY_IMAGE}"
        $${SUDO} ctr -n k8s.io images pull "${KUBE_PROXY_IMAGE}"
        $${SUDO} ctr -n k8s.io images tag "${KUBE_PROXY_IMAGE}" "registry.k8s.io/kube-proxy:latest"
        
        systemctl restart kubelet
      else
        echo "* Custom image environment variables not set, skipping custom image handling"
      fi
      echo "* checking binary versions"
      echo "ctr version: " $(ctr version)
      echo "kubeadm version: " $(kubeadm version -o=short)
      echo "kubectl version: " $(kubectl version --client=true)
      echo "kubelet version: " $(kubelet --version)
      echo "$$LINE_SEPARATOR"
    path: /tmp/kubeadm-bootstrap.sh
    owner: "root:root"
    permissions: "0744"
- op: add
  path: /spec/kubeadmConfigSpec/preKubeadmCommands/-
  value:
    bash -c /tmp/kubeadm-bootstrap.sh
- op: add
  path: /spec/kubeadmConfigSpec/verbosity
  value: 5